const Components = require('../../components.json');
const path = require('path');
const fs = require('fs');
const uppercamelcase = require('uppercamelcase');
const pkg = require('../../package.json');

const OUTPUT_PATH = path.join(__dirname, '../../types/index.d.ts');
const basepath = path.join(__dirname, '../../types/');
const importComponentTemplate = [];
const listTemplate = [];

function fileExists(filePath) {
  try {
    return fs.statSync(filePath).isFile();
  } catch (err) {
    return false;
  }
}

Object.keys(Components).forEach((name) => {
  const componentName = uppercamelcase(name);
  // check
  const filePath = path.resolve(basepath, `${name}.d.ts`);
  if (!fileExists(filePath)) {
    fs.writeFileSync(filePath, '', 'utf8');
    throw new Error(`types: 遗漏 ${name} 组件类型定义文件`);
  }

  const importPath = `./${name}`;
  if (['message', 'notification', 'confirm'].includes(name)) {
    return;
  }
  importComponentTemplate.push(`import { ${componentName} } from '${importPath}';`);
  listTemplate.push(componentName);
});

const importStr = importComponentTemplate.join('\n');
const listStr = listTemplate.join(',\n  ');

const template = `/* Automatically generated by './build/bin/build-ts.js' */
${importStr}
import { Confirm as WTConfirm } from './confirm';
import {
  Message as WTMessage,
  MessageOptions
} from './message';
import {
  Notification as WTNotification,
  NotificationOptions
} from './notification';
import { FormRule, FormRules } from './form';
import ExpansionTransition from './expansion-transition';

export const Message: WTMessage;
export const Notification: WTNotification;
export const Confirm: WTConfirm;

export {
  ${listStr},
  FormRule,
  FormRules,
  NotificationOptions,
  MessageOptions,
  ExpansionTransition,
};

export declare function install(vue: any): void;

declare module 'vue/types/vue' {
  interface Vue {
    $wt: {
      confirm: WTConfirm
      message: WTMessage
      notify: WTNotification
    }
  }
}
`;
fs.writeFileSync(OUTPUT_PATH, template);
console.log('[build entry] DONE:', OUTPUT_PATH);
